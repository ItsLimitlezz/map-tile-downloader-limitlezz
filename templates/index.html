<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MeshStudio Lite</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.1/socket.io.js"></script>
    <style>
        :root {
            --panel-bg: rgba(232, 233, 241, 0.94);
            --card-bg: rgba(224, 226, 236, 0.92);
            --text-main: #1f2330;
            --text-muted: #6b6f7b;
            --line: rgba(42, 47, 61, 0.15);
            --blue: #0a69e8;
            --blue-dark: #0458cc;
        }
        html, body {
            margin: 0;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
            color: var(--text-main);
        }
        #map {
            height: 100vh;
            width: 100%;
        }
        .form-container {
            position: absolute;
            top: 12px;
            left: 12px;
            right: auto;
            bottom: auto;
            z-index: 1000;
            width: clamp(340px, 30vw, 520px);
            max-height: calc(100vh - 24px);
            background: var(--panel-bg);
            backdrop-filter: blur(16px) saturate(120%);
            -webkit-backdrop-filter: blur(16px) saturate(120%);
            border: 1px solid rgba(255, 255, 255, 0.65);
            box-shadow: 0 10px 28px rgba(0, 8, 30, 0.25);
            border-radius: 18px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .panel-header {
            padding: 20px 18px 12px;
            text-align: center;
        }
        .panel-title {
            margin: 0;
            font-size: 40px;
            font-weight: 760;
            letter-spacing: -0.02em;
            line-height: 1;
        }
        .panel-subtitle {
            margin-top: 6px;
            font-size: 14px;
            color: var(--text-muted);
        }
        #downloadForm {
            flex: 1;
            overflow-y: auto;
            padding: 0 14px 14px;
        }
        .leaflet-left {
            left: auto;
            right: 12px;
        }
        .leaflet-right {
            right: 12px;
        }
        .section {
            margin-bottom: 14px;
        }
        .section-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 700;
            font-size: 19px;
            margin-bottom: 8px;
        }
        .section-card {
            background: var(--card-bg);
            border: 1px solid rgba(255, 255, 255, 0.55);
            border-radius: 14px;
            padding: 12px;
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.5);
        }
        .hint {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 10px;
            text-align: center;
        }
        .row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        .row.wrap {
            flex-wrap: wrap;
        }
        .row label {
            min-width: 110px;
            font-size: 15px;
        }
        input[type="text"], input[type="number"], select {
            border: 1px solid var(--line);
            background: rgba(255, 255, 255, 0.88);
            border-radius: 10px;
            padding: 6px 9px;
            color: var(--text-main);
            outline: none;
            transition: box-shadow 0.18s ease, border-color 0.18s ease;
            font-size: 15px;
        }
        #output_dir {
            flex: 1;
            min-width: 90px;
        }
        #min_zoom, #max_zoom {
            width: 58px;
        }
        #map_style {
            flex: 1;
        }
        input[type="text"]:focus, input[type="number"]:focus, select:focus {
            border-color: #3a86ff;
            box-shadow: 0 0 0 3px rgba(58, 134, 255, 0.18);
        }
        .btn {
            border: 1px solid var(--line);
            border-radius: 11px;
            background: rgba(255, 255, 255, 0.82);
            color: var(--text-main);
            padding: 7px 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        .btn.small {
            padding: 6px 10px;
            font-size: 14px;
            min-width: 80px;
        }
        .btn.primary {
            background: linear-gradient(180deg, var(--blue), var(--blue-dark));
            color: #fff;
            border-color: transparent;
            box-shadow: 0 5px 12px rgba(6, 82, 187, 0.34);
        }
        .btn:disabled {
            opacity: 0.45;
            cursor: not-allowed;
            box-shadow: none;
        }
        .output-pills {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 5px 10px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 700;
            color: #323646;
            background: rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.6);
        }
        .pill input { accent-color: var(--blue); }
        .pill.active {
            background: linear-gradient(180deg, var(--blue), var(--blue-dark));
            color: #fff;
            border-color: transparent;
        }
        .pill.active input {
            filter: brightness(0) invert(1);
        }
        .checks {
            margin-top: 8px;
            font-size: 14px;
            display: grid;
            row-gap: 6px;
        }
        .checks label {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .checks input[type="checkbox"] {
            accent-color: var(--blue);
        }
        .progress-panel {
            color: var(--text-main);
        }
        .progress-meta {
            display: grid;
            gap: 8px;
            font-size: 14px;
            margin-bottom: 10px;
        }
        .progress-row {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            margin-bottom: 6px;
        }
        .progress-track {
            width: 100%;
            height: 8px;
            border-radius: 999px;
            background: rgba(145, 152, 173, 0.35);
            overflow: hidden;
            margin-bottom: 10px;
        }
        .progress-fill {
            height: 100%;
            width: 0;
            border-radius: 999px;
            background: linear-gradient(90deg, #1475ff, #57b2ff);
            transition: width 0.2s ease;
        }
        .progress-current {
            font-size: 14px;
            margin-bottom: 5px;
        }
        .progress-output {
            font-size: 12px;
            color: var(--text-muted);
            word-break: break-word;
        }
        .bottom-bar {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(111, 118, 140, 0.25);
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .extra-row {
            margin-top: 8px;
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        @media (max-width: 768px) {
            .form-container {
                width: calc(100vw - 10px);
                left: 5px;
                right: 5px;
                top: 5px;
                bottom: auto;
                max-height: 82vh;
                border-radius: 14px;
            }
            .leaflet-left {
                right: 8px;
            }
            .panel-title {
                font-size: 34px;
            }
        }
    </style>
</head>
<body>
    <div style="position: relative;">
        <div id="map"></div>
        <div class="form-container">
            <div class="panel-header">
                <h1 class="panel-title">MeshStudio Lite</h1>
                <div class="panel-subtitle">Download maps for your mesh devices</div>
            </div>
            <form id="downloadForm">
                <div class="section">
                    <div class="section-title">üìÅ Output Settings</div>
                    <div class="section-card">
                        <div class="hint">Please select either an SD card or a folder</div>
                        <div class="row">
                            <label for="output_dir">Output Directory:</label>
                            <input type="text" id="output_dir" name="output_dir">
                            <button type="button" id="chooseOutputBtn" class="btn small">Choose‚Ä¶</button>
                        </div>
                        <div class="row">
                            <label>Outputs:</label>
                            <div class="output-pills">
                                <label id="pngPill" class="pill active">
                                    <input type="checkbox" id="convert_to_8bit" checked> PNG
                                </label>
                                <label id="binPill" class="pill">
                                    <input type="checkbox" id="convert_to_rgb565_bin_files"> BIN
                                </label>
                            </div>
                            <span style="font-size:12px;color:var(--text-muted)">Choose one or both</span>
                        </div>
                        <div class="checks">
                            <label><input type="checkbox" id="use_cache" name="use_cache"> Use cached tiles</label>
                            <label><input type="checkbox" id="view_cached_tiles"> View cached tiles</label>
                        </div>
                        <div class="row wrap" style="margin-top:10px">
                            <label for="map_style">Map Style:</label>
                            <select id="map_style" name="map_style"></select>
                        </div>
                        <div class="row">
                            <label for="min_zoom">Min Zoom:</label>
                            <input type="number" id="min_zoom" name="min_zoom" min="0" max="19" value="10" required>
                            <label for="max_zoom" style="min-width:auto">Max:</label>
                            <input type="number" id="max_zoom" name="max_zoom" min="0" max="19" value="12" required>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">üìÅ Progress</div>
                    <div id="progressPanel" class="section-card progress-panel">
                        <div class="progress-meta">
                            <div id="estimateLine">Estimated: 0 tiles (~0.0 MB)</div>
                            <div id="etaLine">Est. download time: --</div>
                        </div>
                        <div class="progress-row">
                            <span>Overall Progress</span>
                            <span id="progressStatus">Not downloading</span>
                        </div>
                        <div class="progress-track">
                            <div id="progressFill" class="progress-fill"></div>
                        </div>
                        <div id="currentLine" class="progress-current">Current: Downloaded: 0 | Converted: 0 | Failed: 0</div>
                        <div id="outputLine" class="progress-output"></div>
                    </div>
                </div>

                <div class="bottom-bar">
                    <button type="button" id="downloadBtn" class="btn primary">‚¨á Start Download</button>
                    <button type="button" id="openOutputBtn" class="btn">üìÅ Open Output Folder</button>
                </div>
                <div class="extra-row">
                    <button type="button" id="downloadWorldBtn" class="btn small">World Basemap</button>
                    <button type="button" id="cancelBtn" class="btn small" disabled>Cancel</button>
                    <button type="button" id="deleteCacheBtn" class="btn small">Delete Cache</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        var socket = io();
        var map = L.map('map');
        map.setView([51.505, -0.09], 13);

        var tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        }).addTo(map);

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                map.setView([position.coords.latitude, position.coords.longitude], 13);
            }, function() {}, { timeout: 5000, maximumAge: 0 });
        }

        var drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);

        var drawControl = new L.Control.Draw({
            draw: { polygon: true, marker: false, circle: false, circlemarker: false, polyline: false, rectangle: true },
            edit: { featureGroup: drawnItems }
        });
        map.addControl(drawControl);

        map.on('draw:created', function(e) {
            drawnItems.addLayer(e.layer);
            document.getElementById('downloadBtn').disabled = drawnItems.getLayers().length === 0;
        });

        map.on('draw:deleted', function() {
            document.getElementById('downloadBtn').disabled = drawnItems.getLayers().length === 0;
        });

        var missingTilesLayer = L.layerGroup().addTo(map);
        var cachedTilesLayer = L.layerGroup().addTo(map);
        var downloadProgressLayer = L.layerGroup().addTo(map);

        function onTileError(e) {
            var coords = e.coords;
            var z = coords.z;
            var x = coords.x;
            var y = coords.y;
            var topLeft = map.unproject([x * 256, y * 256], z);
            var bottomRight = map.unproject([(x + 1) * 256, (y + 1) * 256], z);
            var bounds = L.latLngBounds(topLeft, bottomRight);
            L.rectangle(bounds, { color: 'red', weight: 1, fill: false }).addTo(missingTilesLayer);
        }

        function sanitizeStyleName(name) {
            name = name.replace(/\s+/g, '-');
            name = name.replace(/[^a-zA-Z0-9-_]/g, '');
            return name;
        }

        function updateTileLayer() {
            var mapStyleSelect = document.getElementById('map_style');
            var mapStyleUrl = mapStyleSelect.value;
            var styleName = sanitizeStyleName(mapStyleSelect.options[mapStyleSelect.selectedIndex].text);
            var useCache = document.getElementById('use_cache').checked;
            var tileUrl = useCache ? '/tiles/' + styleName + '/{z}/{x}/{y}.png' : mapStyleUrl;
            tileLayer.setUrl(tileUrl);
            tileLayer.off('loading');
            tileLayer.off('tileerror', onTileError);
            missingTilesLayer.clearLayers();
            if (useCache) {
                tileLayer.on('loading', function() {
                    missingTilesLayer.clearLayers();
                });
                tileLayer.on('tileerror', onTileError);
            }
        }

        function syncOutputPills() {
            document.getElementById('pngPill').classList.toggle('active', document.getElementById('convert_to_8bit').checked);
            document.getElementById('binPill').classList.toggle('active', document.getElementById('convert_to_rgb565_bin_files').checked);
        }

        fetch('/get_map_sources')
            .then(function(response) { return response.json(); })
            .then(function(data) {
                var select = document.getElementById('map_style');
                for (var name in data) {
                    var option = document.createElement('option');
                    option.value = data[name];
                    option.text = name;
                    select.appendChild(option);
                }
                updateTileLayer();
            });

        fetch('/get_default_output_dir')
            .then(function(response) { return response.json(); })
            .then(function(data) {
                var outputInput = document.getElementById('output_dir');
                var stored = localStorage.getItem('mapTileOutputDir');
                outputInput.value = stored ? stored : data.output_dir;
            });

        document.getElementById('map_style').addEventListener('change', function() {
            updateTileLayer();
            if (document.getElementById('view_cached_tiles').checked) {
                showCachedTiles();
            }
        });

        document.getElementById('use_cache').addEventListener('change', updateTileLayer);

        document.getElementById('chooseOutputBtn').addEventListener('click', function() {
            var current = document.getElementById('output_dir').value;
            var selected = window.prompt('Enter output folder path:', current);
            if (selected !== null && selected.trim()) {
                document.getElementById('output_dir').value = selected.trim();
                localStorage.setItem('mapTileOutputDir', selected.trim());
            }
        });

        document.getElementById('openOutputBtn').addEventListener('click', function() {
            var out = document.getElementById('output_dir').value.trim();
            if (!out) {
                alert('Set an output folder first.');
                return;
            }
            window.prompt('Open this folder in Finder/Explorer:', out);
        });

        document.getElementById('convert_to_rgb565_bin_files').addEventListener('change', function() {
            if (this.checked) {
                document.getElementById('convert_to_8bit').checked = true;
            }
            syncOutputPills();
        });

        document.getElementById('convert_to_8bit').addEventListener('change', syncOutputPills);

        document.getElementById('downloadBtn').addEventListener('click', function() {
            var polygons = [];
            drawnItems.eachLayer(function(layer) {
                if (layer instanceof L.Polygon) {
                    var latlngs = layer.getLatLngs()[0];
                    polygons.push(latlngs.map(function(latlng) { return [latlng.lat, latlng.lng]; }));
                }
            });

            if (polygons.length === 0) {
                alert('Please draw at least one shape.');
                return;
            }

            socket.emit('start_download', {
                polygons: polygons,
                min_zoom: parseInt(document.getElementById('min_zoom').value, 10),
                max_zoom: parseInt(document.getElementById('max_zoom').value, 10),
                map_style: document.getElementById('map_style').value,
                output_dir: document.getElementById('output_dir').value.trim(),
                convert_to_8bit: document.getElementById('convert_to_8bit').checked,
                convert_to_rgb565_bin_files: document.getElementById('convert_to_rgb565_bin_files').checked
            });
        });

        document.getElementById('downloadWorldBtn').addEventListener('click', function() {
            socket.emit('start_world_download', {
                map_style: document.getElementById('map_style').value,
                output_dir: document.getElementById('output_dir').value.trim(),
                convert_to_8bit: document.getElementById('convert_to_8bit').checked,
                convert_to_rgb565_bin_files: document.getElementById('convert_to_rgb565_bin_files').checked
            });
        });

        document.getElementById('deleteCacheBtn').addEventListener('click', function() {
            if (!confirm('Are you sure you want to delete the cached tiles for this style?')) {
                return;
            }
            var mapStyleSelect = document.getElementById('map_style');
            var styleName = sanitizeStyleName(mapStyleSelect.options[mapStyleSelect.selectedIndex].text);
            fetch('/delete_cache/' + styleName, { method: 'DELETE' })
                .then(function(response) {
                    if (response.ok) {
                        alert('Cache deleted successfully');
                        if (document.getElementById('view_cached_tiles').checked) {
                            showCachedTiles();
                        }
                    } else {
                        alert('Failed to delete cache');
                    }
                });
        });

        document.getElementById('cancelBtn').addEventListener('click', function() {
            socket.emit('cancel_download');
        });

        document.getElementById('view_cached_tiles').addEventListener('change', function() {
            if (this.checked) {
                showCachedTiles();
            } else {
                cachedTilesLayer.clearLayers();
            }
        });

        function showCachedTiles() {
            cachedTilesLayer.clearLayers();
            var mapStyleSelect = document.getElementById('map_style');
            var styleName = sanitizeStyleName(mapStyleSelect.options[mapStyleSelect.selectedIndex].text);
            fetch('/get_cached_tiles/' + styleName)
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    data.forEach(function(tile) {
                        var z = tile[0], x = tile[1], y = tile[2];
                        var topLeft = map.unproject([x * 256, y * 256], z);
                        var bottomRight = map.unproject([(x + 1) * 256, (y + 1) * 256], z);
                        var bounds = L.latLngBounds(topLeft, bottomRight);
                        L.rectangle(bounds, { color: '#0000ff', weight: 1, fill: false }).addTo(cachedTilesLayer);
                    });
                });
        }

        var totalTiles = 0;
        var downloadedTiles = 0;
        var skippedTiles = 0;
        var failedTiles = 0;
        var convertedTiles = 0;
        var downloadedBytesTotal = 0;
        var bytesSampleCount = 0;
        var downloadStartTimestamp = 0;
        var transferState = 'idle';
        var defaultTileBytes = 125 * 1024;

        function formatApproxMb(bytes) {
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function formatDuration(seconds) {
            if (!isFinite(seconds) || seconds < 0) {
                return '--';
            }
            var mins = Math.floor(seconds / 60);
            var secs = Math.floor(seconds % 60);
            return mins > 0 ? mins + 'm ' + secs + 's' : secs + 's';
        }

        function statusText() {
            if (transferState === 'downloading') return 'Downloading';
            if (transferState === 'finishing') return 'Finishing';
            if (transferState === 'completed') return 'Completed';
            if (transferState === 'cancelled') return 'Cancelled';
            if (transferState === 'error') return 'Error';
            return 'Not downloading';
        }

        function updateProgressCard() {
            var processedTiles = downloadedTiles + skippedTiles + failedTiles;
            var progressRatio = totalTiles > 0 ? processedTiles / totalTiles : 0;
            if (progressRatio < 0) progressRatio = 0;
            if (progressRatio > 1) progressRatio = 1;

            var averageTileBytes = bytesSampleCount > 0 ? downloadedBytesTotal / bytesSampleCount : defaultTileBytes;
            var estimatedTotalBytes = totalTiles * averageTileBytes;

            var etaText = '--';
            if (transferState === 'downloading' || transferState === 'finishing') {
                var elapsedSec = downloadStartTimestamp > 0 ? (Date.now() - downloadStartTimestamp) / 1000 : 0;
                var tilesPerSecond = elapsedSec > 0 ? processedTiles / elapsedSec : 0;
                var remainingTiles = Math.max(totalTiles - processedTiles, 0);
                etaText = tilesPerSecond > 0 ? formatDuration(remainingTiles / tilesPerSecond) : '--';
            }

            document.getElementById('estimateLine').textContent =
                'Estimated: ' + totalTiles.toLocaleString() + ' tiles (~' + formatApproxMb(estimatedTotalBytes) + ')';
            document.getElementById('etaLine').textContent = 'Est. download time: ' + etaText;
            document.getElementById('progressStatus').textContent = statusText();
            document.getElementById('progressFill').style.width = (progressRatio * 100).toFixed(2) + '%';
            document.getElementById('currentLine').textContent =
                'Current: Downloaded: ' + downloadedTiles +
                ' | Converted: ' + convertedTiles +
                ' | Failed: ' + failedTiles;
        }

        socket.on('download_started', function(data) {
            totalTiles = data.total_tiles;
            downloadedTiles = 0;
            skippedTiles = 0;
            failedTiles = 0;
            convertedTiles = 0;
            downloadedBytesTotal = 0;
            bytesSampleCount = 0;
            downloadStartTimestamp = Date.now();
            transferState = 'downloading';
            downloadProgressLayer.clearLayers();
            document.getElementById('cancelBtn').disabled = false;
            document.getElementById('outputLine').textContent = '';
            updateProgressCard();
        });

        socket.on('tile_downloaded', function(data) {
            downloadedTiles++;
            if (typeof data.size_bytes === 'number') {
                downloadedBytesTotal += data.size_bytes;
                bytesSampleCount++;
            }
            updateProgressCard();
            var bounds = [[data.south, data.west], [data.north, data.east]];
            L.rectangle(bounds, { color: '#ff7800', weight: 1, fill: false }).addTo(downloadProgressLayer);
        });

        socket.on('tile_skipped', function(data) {
            skippedTiles++;
            if (typeof data.size_bytes === 'number') {
                downloadedBytesTotal += data.size_bytes;
                bytesSampleCount++;
            }
            updateProgressCard();
            var bounds = [[data.south, data.west], [data.north, data.east]];
            L.rectangle(bounds, { color: '#00ff00', weight: 1, fill: false }).addTo(downloadProgressLayer);
        });

        socket.on('tile_converted', function() {
            convertedTiles++;
            updateProgressCard();
        });

        socket.on('tile_failed', function() {
            failedTiles++;
            updateProgressCard();
        });

        socket.on('tiles_downloaded', function() {
            transferState = 'finishing';
            updateProgressCard();
        });

        socket.on('download_complete', function(data) {
            document.getElementById('cancelBtn').disabled = true;
            downloadProgressLayer.clearLayers();
            transferState = 'completed';
            document.getElementById('outputLine').textContent = 'Output: ' + data.output_dir;
            updateProgressCard();
        });

        socket.on('download_cancelled', function() {
            document.getElementById('cancelBtn').disabled = true;
            downloadProgressLayer.clearLayers();
            transferState = 'cancelled';
            updateProgressCard();
            alert('Download cancelled');
        });

        socket.on('error', function(data) {
            transferState = 'error';
            updateProgressCard();
            alert(data.message);
        });

        syncOutputPills();
        updateProgressCard();
    </script>
</body>
</html>
